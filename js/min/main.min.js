let API_KEY;import{currentForecast}from"./current_forecast.min.js";import{settings,cacheData,cachedLang,cachedData,changeHistory,editHistory,editSettings,addToFav,favList,editFav,langHandler}from"./read_storage.min.js";import{dailyForecast}from"./daily_forecast.min.js";import{weeklyForecast,setCardData}from"./weekly_forecast.min.js";const body=document.querySelector("body"),main=document.querySelector("main"),menuNav=document.querySelector(".menu-dd-navbar"),menuNavRadio=document.querySelectorAll('[name="radio-menu-dd-nav"]'),menuDropdown=document.querySelector(".menu-dd"),menuDropdownWrapper=document.querySelector(".menu-dd-wrapper"),menuDropdownHide=document.querySelectorAll(".menu-dd-hideable"),menuLocWrapper=document.querySelector(".menu-dd-location-wrapper"),menuHistWrapper=document.querySelector(".menu-dd-history-wrapper"),menuSettWrapper=document.querySelector(".menu-dd-sett-wrapper"),menuFavWrapper=document.querySelector(".menu-dd-fav-wrapper"),searchInput=document.querySelector(".search-bar"),menuFavButton=document.querySelector(".button-sfd-add-fav"),clearStorageButton=document.querySelector(".button-clear-storage"),resetInputButton=document.querySelectorAll(".button-reset-input"),settingsButton=document.querySelector(".button-settings"),noAnimCheckbox=document.querySelector(".checkbox-no-anim"),clockModeCheckbox=document.querySelector(".checkbox-clock-mode"),resultNavRadio=document.querySelectorAll('[name="radio-result-nav"]'),weekdayCardRadio=document.querySelectorAll('[name="radio-wf-weekday-card"]'),measurementSelect=document.querySelector('[name="select-measurement-units"]'),themeSelect=document.querySelector('[name="select-theme"]'),langSelect=document.querySelector('[name="select-lang"]'),chartDataSelect=document.querySelector('[name="select-df-chart-data-type"]'),tooltip=document.querySelector(".tooltip"),resultBox=document.querySelector(".result-container"),refreshTime=document.querySelector(".refresh-time"),refreshLink=document.querySelector(".refresh-link");let isDropdownOpened=!1;const navbarMobile=document.querySelector(".navbar-wrapper"),weekdayWrapper=document.querySelector(".wf-weekday-nav"),forwardButton=document.querySelector(".button-result-nav-forward"),backwardButton=document.querySelector(".button-result-nav-backward"),mobileWeekdayButton=document.querySelector(".button-wf-mobile-weekday"),searchButton=document.querySelector(".button-search");let weatherData={location:null,weather:null,pollution:null,unitsTypes:null},date=new Date;const hideToggler=(hideList,unhideList)=>{null!=hideList&&(!Array.isArray(hideList)&&(hideList=new Array(hideList)),hideList.forEach(e=>{0==Array.from(e).length?(e.classList.add("box-hidden"),e.ariaHidden=!0):e.forEach(el=>{el.classList.add("box-hidden"),e.ariaHidden=!0})})),null!=unhideList&&(!Array.isArray(unhideList)&&(unhideList=new Array(unhideList)),unhideList.forEach(e=>{0==Array.from(e).length?(e.classList.remove("box-hidden"),e.ariaHidden=!1):e.forEach(el=>{el.classList.remove("box-hidden"),e.ariaHidden=!1})}))},themeToggler=()=>{const weather=weatherData.weather?weatherData.weather.current:void 0,clock=new Date;main.classList="","default"==settings.theme&!weather|"local"==settings.theme?main.classList.add(clock.getHours()<6||clock.getHours()>18?"theme-day":"theme-night"):"default"==settings.theme?main.classList.add(weather.dt>weather.sunrise&&weather.dt<weather.sunset?"theme-day":"theme-night"):"night"==settings.theme?main.classList.add("theme-night"):"day"==settings.theme?main.classList.add("theme-day"):"contrast"==settings.theme&&main.classList.add("theme-contrast")},resetSearch=()=>{searchInput.value="",tooltip.classList.replace("col-err","col-sec"),tooltip.innerHTML=cachedLang.generic["tooltip-default"],document.querySelector("#radio-result-nav1").checked=!0,changeCard(1),hideToggler([resultBox,menuFavButton],tooltip),themeToggler()},getLocation=(searchQuery,overwrite,searchCache)=>{if(searchInput.value=searchQuery,cachedData&&cachedData.location.name==searchQuery&cachedData.unitsTypes==settings.units&!0!==overwrite){let date=(new Date).getTime()/1e3;return Math.floor((date-cachedData.weather.current.dt)/60)<10?(weatherData=cachedData,refreshTime.innerHTML=new Date(1e3*cachedData.weather.current.dt).toLocaleString("pl-PL",{hour:"2-digit",minute:"2-digit",hourCycle:settings.clockMode}),closeDropdown(),setWeatherData(weatherData),void console.log("Readed data from cache")):(weatherData.location=cachedData.location,void getWeatherData(cachedData.location))}if(searchCache)console.log("New API data fetch from saved lat/lon"),fetch(`https://api.openweathermap.org/geo/1.0/reverse?lat=${searchCache.lat}&lon=${searchCache.lon}&limit=1&appid=${API_KEY}`).then(value=>value.json()).then(json=>{if(0==json.length)throw Error(cachedLang.generic["error-cached"]);json[0].name=searchCache.name,weatherData.location=json[0],closeDropdown(),getWeatherData(weatherData.location)}).catch(e=>{tooltip.classList.replace("col-sec","col-err"),tooltip.innerHTML=`<i class="bi bi-cloud-slash"></i><br>${e.message[0].toUpperCase()+e.message.substr(1)}`,hideToggler(resultBox,tooltip)});else{if(""==searchQuery)return void console.log("Input is empty, ignoring");console.log("New API data fetch from user query"),fetch(`https://api.openweathermap.org/geo/1.0/direct?q=${searchQuery}&limit=10&appid=${API_KEY}`).then(value=>value.json()).then(json=>{if(0==json.length)throw Error(cachedLang.generic["error-query"]);if((json=json.filter((value,index,self)=>index===self.findIndex(t=>t.state===value.state))).length>1){document.querySelector('[tkey-gen="menu-loc-desc"]').innerHTML=cachedLang.generic["menu-loc-desc"].replace("%loc-amount",json.length).replace("%loc-phrase",searchQuery),menuDropdown.classList.add("dd-opened"),hideToggler(menuDropdownHide,[menuDropdownWrapper,menuLocWrapper]);let content="";json.forEach(e=>{content+=`<div class="menu-dd-item">\n              <button class="sld-city-select menu-dd-item-city col-prim">\n                  <i class="fi fi-${e.country.toLowerCase()}"></i>\n                  <p class="menu-dd-item-loc">${e.local_names&&e.local_names[settings.lang]||e.name}</p>\n                  <h5 class="menu-dd-item-state">${e.state||"N/A"}</h5>\n              </button>\n              </div>`}),document.querySelector(".sld-wrapper").innerHTML=content,document.querySelectorAll(".sld-city-select").forEach((e,i)=>{e.addEventListener("click",()=>{searchInput.value=json[i].name,weatherData.location=json[i],closeDropdown(),getWeatherData(json[i])})})}else{let loc=weatherData.location=json[0];getWeatherData(loc),closeDropdown()}}).catch(e=>{tooltip.classList.replace("col-sec","col-err"),tooltip.innerHTML=`<i class="bi bi-cloud-slash"></i><br>${e.message[0].toUpperCase()+e.message.substr(1)}`,hideToggler(resultBox,tooltip)})}},getWeatherData=loc=>{Promise.all([fetch(`https://api.openweathermap.org/data/2.5/onecall?lat=${loc.lat}&lon=${loc.lon}&exclude=minutely&units=${settings.units}&lang=${settings.lang}&appid=${API_KEY}`).then(value=>value.json()),fetch(`https://api.openweathermap.org/data/2.5/air_pollution?lat=${loc.lat}&lon=${loc.lon}&appid=${API_KEY}`).then(value=>value.json())]).then(([weather,pollution])=>{weather.daily.shift(),weather.hourly.splice(0,24),weatherData.weather=weather,weatherData.pollution=pollution,weatherData.unitsTypes=settings.units,refreshTime.innerHTML=(new Date).toLocaleString("pl-PL",{hour:"2-digit",minute:"2-digit",hourCycle:settings.clockMode}),cacheData(weatherData),changeHistory(weatherData.location),setWeatherData(weatherData)}).catch(e=>{tooltip.classList.replace("col-sec","col-err"),tooltip.innerHTML=`<i class="bi bi-cloud-slash"></i><br>${e.message[0].toUpperCase()+e.message.substr(1)}`,hideToggler(resultBox,tooltip)})},setWeatherData=weatherData=>{let loc=weatherData.location;document.querySelector("#radio-result-nav1").checked=!0,changeCard(1),document.querySelector('[tkey-gen="menu-fav-button"]').innerHTML=cachedLang.generic["menu-fav-button"].replace("%loc-name",loc.local_names&&loc.local_names[settings.lang]||loc.name),hideToggler([tooltip,menuFavButton],resultBox),favList.find(el=>el.name===loc.name&el.country===loc.country&(null==loc.state||el.state===loc.state))||hideToggler(...Array(1),menuFavButton),themeToggler(),currentForecast(weatherData),dailyForecast(weatherData),weeklyForecast(weatherData)},editTimer=()=>{date=new Date,document.querySelector(".city-date-data").innerHTML=date.toLocaleDateString("pl-PL",{timeZone:weatherData.weather?weatherData.weather.timezone:"etc/utc",day:"2-digit",month:"2-digit",year:"numeric"}),document.querySelector(".city-time-data").innerHTML=date.toLocaleTimeString("pl-PL",{timeZone:weatherData.weather?weatherData.weather.timezone:"etc/utc",hour:"2-digit",minute:"2-digit",second:"2-digit",hourCycle:settings.clockMode}),setTimeout(()=>{editTimer()},1e3)},closeDropdown=()=>{hideToggler([menuDropdownWrapper,menuDropdownHide],[menuHistWrapper,menuNav]),[menuDropdown,weekdayWrapper,navbarMobile].forEach(e=>e.classList.remove("dd-opened")),document.querySelector("#radio-menu-dd-nav1").checked=!0,isDropdownOpened=!1};function changeCard(cardID,dir){const radios=document.querySelectorAll('[name="radio-result-nav"]');cardID||(cardID=parseInt(document.querySelector('[name="radio-result-nav"]:checked').value.slice(-1))),dir&&("forward"==dir?cardID++:cardID--),cardID>radios.length&&(cardID=1),cardID<1&&(cardID=radios.length),document.querySelector(`#radio-result-nav${cardID}`).checked=!0;const card=document.querySelector(`.card${cardID}`);hideToggler(document.querySelectorAll(".weather-box"),card),card.scrollTo({top:0,behavior:"smooth"})}function changeDropdownCard(cardName){hideToggler(menuDropdownHide,[document.querySelector(`.${cardName}`),menuNav])}searchInput.addEventListener("change",e=>{getLocation(e.target.value),searchInput.blur()}),searchInput.addEventListener("click",e=>{hideToggler(...Array(1),menuDropdownWrapper),menuDropdown.classList.add("dd-opened"),isDropdownOpened=!0}),menuFavButton.addEventListener("click",()=>{addToFav(weatherData.location)}),resetInputButton.forEach(e=>e.addEventListener("click",()=>{resetSearch(),e.style.animation="rotate-once 1s",e.disabled=!0,setTimeout(()=>{e.style.animation="",e.disabled=!1},1e3)})),settingsButton.addEventListener("click",()=>{hideToggler(menuHistWrapper,[menuDropdownWrapper,menuSettWrapper]),document.querySelector("#radio-menu-dd-nav3").checked=!0,[menuDropdown,navbarMobile].forEach(e=>e.classList.add("dd-opened")),isDropdownOpened=!0}),searchButton.addEventListener("click",()=>{hideToggler([menuSettWrapper,menuFavWrapper],[menuDropdownWrapper,menuHistWrapper]),document.querySelector("#radio-menu-dd-nav1").checked=!0,[menuDropdown,navbarMobile].forEach(e=>e.classList.add("dd-opened")),searchInput.focus(),searchInput.select(),isDropdownOpened=!0}),clearStorageButton.addEventListener("click",()=>{let prompt;!0===confirm(null!=cachedLang?cachedLang.generic["menu-sett-clear-prompt"]:"Are you sure?")&&(console.log("Cleared local storage!"),localStorage.clear(),editSettings(...Array(5),!0))}),forwardButton.addEventListener("click",()=>{changeCard(...Array(1),"forward"),forwardButton.style.animation="arrow-right 1s",forwardButton.disabled=!0,setTimeout(()=>{forwardButton.style.animation="",forwardButton.disabled=!1},1e3)}),backwardButton.addEventListener("click",()=>{changeCard(...Array(1),"backward"),backwardButton.style.animation="arrow-left 1s",backwardButton.disabled=!0,setTimeout(()=>{backwardButton.style.animation="",backwardButton.disabled=!1},1e3)}),mobileWeekdayButton.addEventListener("click",()=>{hideToggler(menuHistWrapper,[menuDropdownWrapper,menuSettWrapper]),document.querySelector("#radio-menu-dd-nav3").checked=!0,[weekdayWrapper,navbarMobile].forEach(e=>e.classList.add("dd-opened")),isDropdownOpened=!0}),measurementSelect.addEventListener("change",()=>{editSettings(measurementSelect.value),searchInput.value&&getWeatherData(weatherData.location)}),chartDataSelect.addEventListener("change",()=>{dailyForecast(weatherData)}),themeSelect.addEventListener("change",()=>{editSettings(...Array(3),themeSelect.value)}),langSelect.addEventListener("change",async()=>{editSettings(...Array(4),langSelect.value),null!=weatherData.location&&getWeatherData(weatherData.location)});for(let button of resultNavRadio)button.addEventListener("click",()=>changeCard(parseInt(button.value.slice(-1))));for(let button of menuNavRadio)button.addEventListener("click",()=>changeDropdownCard(button.value));for(let button of weekdayCardRadio)button.addEventListener("click",()=>{null!=weatherData.weather&&(setCardData(button.value,weatherData),document.querySelector(".wf-info-wrapper").scrollTo({top:0,behavior:"smooth"}))});refreshLink.addEventListener("click",()=>{getWeatherData(weatherData.location)}),clockModeCheckbox.addEventListener("click",()=>{editSettings(...Array(1),!0)}),noAnimCheckbox.addEventListener("click",()=>{editSettings(...Array(2),!0)}),window.addEventListener("load",async()=>{if(await fetch("./js/api_key.json").then(res=>res.json().then(r=>API_KEY=r.API_KEY)),themeToggler(),clockModeCheckbox.checked="h12"==settings.clockMode,noAnimCheckbox.checked=!1===settings.anim,measurementSelect.value=settings.units,themeSelect.value=settings.theme,langSelect.value=settings.lang,await langHandler(),editTimer(),editHistory(),editFav(),cachedData){let name=cachedData.location.name;getLocation(name)}setTimeout(()=>{!0===settings.anim&&body.classList.remove("no-anim")},500)}),window.addEventListener("click",e=>{!(menuDropdown.contains(e.target)|e.target.classList.contains("menu-dd-nohide"))&!0===isDropdownOpened&&closeDropdown()});export{getLocation,themeToggler,hideToggler,weatherData};